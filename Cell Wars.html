<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cell Wars - Ecosystem Evolution</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2d1b1b 0%, #4a2c2c 100%);
        color: #ffffff;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        text-align: center;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 243, 228, 0.03);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(42, 24, 24, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 218, 193, 0.15);
      }

      h1 {
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 300;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ff9a56, #ff7b54);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 4px rgba(42, 24, 24, 0.3);
      }

      .subtitle {
        font-size: 1.1rem;
        color: #d4a574;
        margin-bottom: 30px;
        font-weight: 300;
      }

      .control-panel {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
        padding: 20px;
        background: rgba(255, 218, 193, 0.08);
        border-radius: 15px;
        border: 1px solid rgba(255, 154, 86, 0.15);
      }

      button {
        padding: 12px 24px;
        font-size: 0.95rem;
        font-weight: 500;
        border: none;
        border-radius: 25px;
        background: linear-gradient(135deg, #ff9a56 0%, #ff7b54 100%);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 154, 86, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: inherit;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 154, 86, 0.4);
        background: linear-gradient(135deg, #ff7b54 0%, #ff9a56 100%);
      }

      button:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(255, 154, 86, 0.3);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .status-panel {
        margin: 20px 0;
        padding: 15px 25px;
        background: rgba(255, 243, 228, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(255, 218, 193, 0.15);
        font-size: 1.1rem;
        font-weight: 300;
      }

      #stats {
        font-weight: 500;
        color: #ffffff;
      }

      #grid {
        display: grid;
        grid-template-columns: repeat(var(--cols), clamp(6px, 1.2vw, 14px));
        gap: 1px;
        justify-content: center;
        margin: 20px auto;
        padding: 20px;
        background: rgba(42, 24, 24, 0.4);
        border-radius: 15px;
        border: 2px solid rgba(255, 154, 86, 0.2);
        box-shadow: inset 0 2px 10px rgba(42, 24, 24, 0.6);
        max-width: calc(100vw - 80px);
        overflow: hidden;
      }

      .cell {
        width: clamp(6px, 1.2vw, 14px);
        aspect-ratio: 1;
        background: #0a0a0a;
        border-radius: 1px;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
        cursor: pointer;
        box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1);
        will-change: transform, box-shadow;
      }

      .cell:hover {
        transform: scale(1.1);
        box-shadow: 0 0 8px rgba(255, 154, 86, 0.4);
        z-index: 10;
      }

      /* üî• FIRE & ICE THEME - High contrast, elemental feel */
      /* Alternative themes below - uncomment to try different color schemes */

      /* üåà NEON NEON THEME - Maximum contrast, cyberpunk feel
      .red { background: #ff0080; box-shadow: 0 0 15px rgba(255, 0, 128, 0.9); }
      .green { background: #00ff80; box-shadow: 0 0 15px rgba(0, 255, 128, 0.9); }
      .blue { background: #8000ff; box-shadow: 0 0 15px rgba(128, 0, 255, 0.9); }
      */

      /* ‚ö° ELECTRIC STORM THEME - High energy, plasma feel
      .red { background: #ff6b35; box-shadow: 0 0 12px rgba(255, 107, 53, 0.8); }
      .green { background: #f7ff00; box-shadow: 0 0 12px rgba(247, 255, 0, 0.8); }
      .blue { background: #0047ff; box-shadow: 0 0 12px rgba(0, 71, 255, 0.8); }
      */

      /* üåã VOLCANO THEME - Earth tones with high contrast
      .red { background: #ff4500; box-shadow: 0 0 10px rgba(255, 69, 0, 0.7); }
      .green { background: #32cd32; box-shadow: 0 0 10px rgba(50, 205, 50, 0.7); }
      .blue { background: #1e90ff; box-shadow: 0 0 10px rgba(30, 144, 255, 0.7); }
      */

      /* üíé JEWEL THEME - Precious gem colors
      .red { background: #dc143c; box-shadow: 0 0 12px rgba(220, 20, 60, 0.8); }
      .green { background: #00ced1; box-shadow: 0 0 12px rgba(0, 206, 209, 0.8); }
      .blue { background: #9932cc; box-shadow: 0 0 12px rgba(153, 50, 204, 0.8); }
      */

      /* ‚òÄÔ∏è SOLAR FLARE THEME - Hot plasma colors
      .red { background: #ff1744; box-shadow: 0 0 15px rgba(255, 23, 68, 0.9); }
      .green { background: #00e676; box-shadow: 0 0 15px rgba(0, 230, 118, 0.9); }
      .blue { background: #2979ff; box-shadow: 0 0 15px rgba(41, 121, 255, 0.9); }
      */
      .red {
        background: #ff3d00; /* Deep fire orange-red */
        box-shadow: 0 0 12px rgba(255, 61, 0, 0.8);
      }

      .green {
        background: #00e5ff; /* Electric cyan */
        box-shadow: 0 0 12px rgba(0, 229, 255, 0.8);
      }

      .blue {
        background: #9c27b0; /* Deep purple */
        box-shadow: 0 0 12px rgba(156, 39, 176, 0.8);
      }

      .instructions {
        margin-top: 20px;
        padding: 15px 20px;
        background: rgba(255, 243, 228, 0.08);
        border-radius: 10px;
        border: 1px solid rgba(255, 218, 193, 0.15);
        font-size: 0.9rem;
        color: #d4a574;
        line-height: 1.5;
      }

      .instructions strong {
        color: #ffffff;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }

        #grid {
          grid-template-columns: repeat(30, 8px);
          padding: 15px;
          max-width: calc(100vw - 20px);
        }

        .cell {
          width: 8px;
        }

        .control-panel {
          gap: 10px;
          padding: 15px;
        }

        button {
          padding: 10px 18px;
          font-size: 0.85rem;
        }

        .status-panel {
          padding: 12px 18px;
          font-size: 1rem;
        }

        .instructions {
          font-size: 0.8rem;
          padding: 12px 15px;
        }
      }

      @media (max-width: 480px) {
        .control-panel {
          flex-direction: column;
          align-items: center;
        }

        button {
          width: 200px;
          max-width: 90vw;
        }
      }
      #stats {
        margin-top: 10px;
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Cell Wars</h1>
      <p class="subtitle">Optimized Ecosystem Evolution</p>

      <div class="control-panel">
        <button id="startBtn">‚ñ∂ Start</button>
        <button id="resetBtn">üîÑ Reset</button>
        <button id="saveBtn">üíæ Save Pattern</button>
        <button id="loadBtn">üìÇ Load Pattern</button>
        <select
          id="themeSelector"
          style="
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 154, 86, 0.2);
            color: white;
            font-family: inherit;
            margin: 5px;
          "
        >
          <option value="fire-ice">üî• Fire & Ice</option>
          <option value="neon-neon">üåà Neon Cyber</option>
          <option value="electric">‚ö° Electric Storm</option>
          <option value="volcano">üåã Volcano</option>
          <option value="jewel">üíé Jewel Gems</option>
          <option value="solar">‚òÄÔ∏è Solar Flare</option>
        </select>
        <button id="conwayBtn">üéØ Conway Mode</button>
        <button id="speedBtn">‚ö° 2x Speed</button>
        <button id="fullscreenBtn">‚õ∂ Fullscreen</button>
      </div>

      <div class="status-panel">
        <div id="stats">Loading stats...</div>
      </div>

      <div id="grid"></div>

      <div class="instructions">
        <strong>üéÆ Controls:</strong> Space (Start/Stop) ‚Ä¢ R (Reset) ‚Ä¢ S (Speed
        Toggle)<br />
        <strong>üéØ Conway Mode:</strong> Toggle between pure Conway rules vs
        ecosystem simulation<br />
        <strong>üëÜ Click cells</strong> to manually add/remove when paused ‚Ä¢
        <strong>üíæ Save/Load</strong> patterns to localStorage ‚Ä¢
        <strong>üî¢ Generation counter</strong> tracks simulation progress
      </div>
    </div>

    <script>
      // --- 1. KONSTANTIT JA ASETUKSET ---
      const ROWS = 40;
      const COLS = 40;

      // Lajien vakiot
      const SPECIES = ["red", "green", "blue"];

      // Energian kulutus/saanti - alkuper√§inen hyv√§ j√§rjestelm√§
      const ENERGY_LOSS = { red: 1.5, green: 1.0, blue: 0.8 };
      const ENERGY_GAIN = { red: 2, green: 1.5, blue: 1.5 };
      const INITIAL_ENERGY_MIN = 5;
      const INITIAL_ENERGY_RANGE = 6;

      // Lis√§√§ntymiss√§√§nn√∂t - alueellinen etu vaaditaan
      const BIRTH_RULES = {
        red: {
          minNeighbors: 3,
          maxNeighbors: 3,
          condition: (counts) => counts.red > counts.blue + counts.green,
        },
        green: {
          minNeighbors: 3,
          maxNeighbors: 3,
          condition: (counts) =>
            counts.green > counts.red + counts.blue && counts.blue >= 1,
        },
        blue: {
          minNeighbors: 3,
          maxNeighbors: 3,
          condition: (counts) => counts.blue > counts.red + counts.green,
        },
      };

      // Survival rules - Conway-style
      const SURVIVAL_RULES = {
        red: { minNeighbors: 2, maxNeighbors: 3 },
        green: { minNeighbors: 2, maxNeighbors: 3 },
        blue: { minNeighbors: 2, maxNeighbors: 3 },
      };

      // Satunnaisen kipin√§n todenn√§k√∂isyys
      const RANDOM_SPARK_CHANCE = 0.01; // 1%

      // Teeman vaihtamisen funktiot
      const themes = {
        "fire-ice": {
          red: { bg: "#ff3d00", glow: "rgba(255, 61, 0, 0.8)" },
          green: { bg: "#00e5ff", glow: "rgba(0, 229, 255, 0.8)" },
          blue: { bg: "#9c27b0", glow: "rgba(156, 39, 176, 0.8)" },
        },
        "neon-neon": {
          red: { bg: "#ff0080", glow: "rgba(255, 0, 128, 0.9)" },
          green: { bg: "#00ff80", glow: "rgba(0, 255, 128, 0.9)" },
          blue: { bg: "#8000ff", glow: "rgba(128, 0, 255, 0.9)" },
        },
        electric: {
          red: { bg: "#ff6b35", glow: "rgba(255, 107, 53, 0.8)" },
          green: { bg: "#f7ff00", glow: "rgba(247, 255, 0, 0.8)" },
          blue: { bg: "#0047ff", glow: "rgba(0, 71, 255, 0.8)" },
        },
        volcano: {
          red: { bg: "#ff4500", glow: "rgba(255, 69, 0, 0.7)" },
          green: { bg: "#32cd32", glow: "rgba(50, 205, 50, 0.7)" },
          blue: { bg: "#1e90ff", glow: "rgba(30, 144, 255, 0.7)" },
        },
        jewel: {
          red: { bg: "#dc143c", glow: "rgba(220, 20, 60, 0.8)" },
          green: { bg: "#00ced1", glow: "rgba(0, 206, 209, 0.8)" },
          blue: { bg: "#9932cc", glow: "rgba(153, 50, 204, 0.8)" },
        },
        solar: {
          red: { bg: "#ff1744", glow: "rgba(255, 23, 68, 0.9)" },
          green: { bg: "#00e676", glow: "rgba(0, 230, 118, 0.9)" },
          blue: { bg: "#2979ff", glow: "rgba(41, 121, 255, 0.9)" },
        },
      };

      function applyTheme(themeName) {
        const theme = themes[themeName];
        if (!theme) return;

        // Luo tai p√§ivit√§ CSS-s√§√§nn√∂t dynaamisesti
        let styleSheet = document.getElementById("dynamic-theme");
        if (!styleSheet) {
          styleSheet = document.createElement("style");
          styleSheet.id = "dynamic-theme";
          document.head.appendChild(styleSheet);
        }

        styleSheet.textContent = `
          .red { background: ${theme.red.bg} !important; box-shadow: 0 0 12px ${theme.red.glow} !important; }
          .green { background: ${theme.green.bg} !important; box-shadow: 0 0 12px ${theme.green.glow} !important; }
          .blue { background: ${theme.blue.bg} !important; box-shadow: 0 0 12px ${theme.blue.glow} !important; }
        `;
      }

      function toggleConwayMode() {
        conwayMode = !conwayMode;
        conwayBtn.textContent = conwayMode
          ? "üß¨ Ecosystem Mode"
          : "üéØ Conway Mode";
        conwayBtn.style.background = conwayMode
          ? "linear-gradient(135deg, #00d4ff 0%, #0099cc 100%)"
          : "linear-gradient(135deg, #ff9a56 0%, #ff7b54 100%)";

        // Reset simulation when switching modes
        if (interval) stopSimulation();
        resetSimulation();
        updateStats(
          conwayMode
            ? "üéØ Conway Mode: Pure neighbor-based evolution"
            : "üß¨ Ecosystem Mode: Energy-based species interactions"
        );
        setTimeout(() => updateStats(), 3000);
      }

      // --- 2. MUUTTUJAT JA DOM-ELEMENTIT ---
      const grid = document.getElementById("grid");
      const startBtn = document.getElementById("startBtn");
      const speedBtn = document.getElementById("speedBtn");
      const resetBtn = document.getElementById("resetBtn");
      const saveBtn = document.getElementById("saveBtn");
      const loadBtn = document.getElementById("loadBtn");
      const conwayBtn = document.getElementById("conwayBtn");
      const themeSelector = document.getElementById("themeSelector");
      const statsDiv = document.getElementById("stats");
      const fullscreenBtn = document.getElementById("fullscreenBtn");

      // Asetetaan CSS-muuttuja Gridin koon mukaan
      grid.style.setProperty("--cols", COLS);

      let interval = null;
      let intervalTime = 600; // Slightly slower for better performance
      let generation = 0; // Sukupolvien laskuri
      let state; // Simulaation nykyinen tila
      let cellDivs = []; // T√ÑRKE√Ñ: S√§ilytt√§√§ viittaukset DOM-soluihin
      let conwayMode = false; // Toggle for pure Conway rules vs ecosystem

      // --- 3. ALUSTUSFUNKTIOT ---
      function initializeState() {
        state = Array.from({ length: ROWS }, (_, y) =>
          Array.from({ length: COLS }, (_, x) => {
            if (Math.random() < 0.25) return null;
            const type = SPECIES[Math.floor(Math.random() * SPECIES.length)];
            return {
              type: type,
              energy:
                Math.floor(Math.random() * INITIAL_ENERGY_RANGE) +
                INITIAL_ENERGY_MIN,
              age: 0, // Ik√§j√§rjestelm√§ takaisin
              element: null,
            };
          })
        );
      }

      function createInitialGrid() {
        grid.innerHTML = "";
        cellDivs = []; // Nollataan DOM-viittaukset

        for (let y = 0; y < ROWS; y++) {
          cellDivs[y] = [];
          for (let x = 0; x < COLS; x++) {
            const cellDiv = document.createElement("div");
            cellDiv.className = "cell";
            cellDivs[y][x] = cellDiv; // Tallenna viittaus
            grid.appendChild(cellDiv);
          }
        }
        // P√§ivit√§ ruudukko kerran, jotta v√§rit alustetaan
        updateGridDisplay();
      }

      // --- 4. OPTIMOITU RENDER√ñINTI ---
      function updateGridDisplay() {
        // P√§ivitt√§√§ VAIN v√§rit / DOM-luokat, ei luo uusia elementtej√§
        // K√§ytet√§√§n requestAnimationFrame performancea varten
        requestAnimationFrame(() => {
          for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
              const cellDiv = cellDivs[y][x];
              const cell = state[y][x];

              // Optimoitu: Tarkista ensin nykyinen tila
              const currentClasses = cellDiv.className;
              let newClasses = "cell";

              if (cell) {
                newClasses += " " + cell.type;
              }

              // P√§ivit√§ vain jos luokat ovat muuttuneet
              if (currentClasses !== newClasses) {
                cellDiv.className = newClasses;
              }
            }
          }
        });
      }

      // --- 5. LASKENTALOGIIKKA ---
      function getNeighbors(y, x) {
        const neighbors = [];
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            if (dy === 0 && dx === 0) continue;
            const ny = y + dy,
              nx = x + dx;
            if (ny >= 0 && ny < ROWS && nx >= 0 && nx < COLS) {
              neighbors.push(state[ny][nx]);
            }
          }
        }
        return neighbors;
      }

      function getCounts() {
        const counts = { red: 0, green: 0, blue: 0 };
        for (let y = 0; y < ROWS; y++) {
          for (let x = 0; x < COLS; x++) {
            const cell = state[y][x];
            if (cell) counts[cell.type]++;
          }
        }
        return counts;
      }

      function updateStats(extra = "") {
        const c = getCounts();
        statsDiv.innerText = `Gen: ${generation} | üî¥ Red: ${c.red} | üü¢ Green: ${c.green} | üîµ Blue: ${c.blue} ${extra}`;
      }

      function nextState() {
        const newState = state.map((row) =>
          row.map((cell) => (cell ? { ...cell } : null))
        );

        for (let y = 0; y < ROWS; y++) {
          for (let x = 0; x < COLS; x++) {
            const cell = state[y][x];
            const neighbors = getNeighbors(y, x);
            const totalNeighbors = neighbors.filter((n) => n !== null).length;
            const counts = {
              red: neighbors.filter((n) => n && n.type === "red").length,
              green: neighbors.filter((n) => n && n.type === "green").length,
              blue: neighbors.filter((n) => n && n.type === "blue").length,
            };

            if (cell) {
              if (conwayMode) {
                // Pure Conway's Game of Life - all cells equal
                const survives = totalNeighbors === 2 || totalNeighbors === 3;
                if (survives) {
                  newState[y][x] = {
                    type: cell.type, // Keep original type for visual continuity
                    energy: INITIAL_ENERGY_MIN + INITIAL_ENERGY_RANGE, // Full energy
                    age: (cell.age || 0) + 1,
                  };
                } else {
                  newState[y][x] = null; // Dies from isolation or overcrowding
                }
              } else {
                // Ecosystem mode - simpler, more lively energy system
                newState[y][x].age = (cell.age || 0) + 1;
                if (cell.type === "red") {
                  newState[y][x].energy -= 2;
                  if (counts.green >= 1) newState[y][x].energy += 3;
                } else if (cell.type === "green") {
                  newState[y][x].energy -= 1.2;
                  if (counts.green >= 2 && counts.blue >= 1)
                    newState[y][x].energy += 1;
                } else if (cell.type === "blue") {
                  newState[y][x].energy -= 0.6;
                  if (counts.red >= 2) newState[y][x].energy += 2;
                }

                if (newState[y][x].energy <= 0) {
                  newState[y][x] = null;
                }
              }
            } else {
              if (conwayMode) {
                // Conway reproduction: exactly 3 neighbors = birth
                if (totalNeighbors === 3) {
                  newState[y][x] = {
                    type: SPECIES[Math.floor(Math.random() * SPECIES.length)], // Random species
                    energy: INITIAL_ENERGY_MIN + INITIAL_ENERGY_RANGE,
                    age: 0,
                  };
                }
              } else {
                // Ecosystem reproduction: simpler, more lively rules
                if (counts.red >= 3 && counts.red > counts.blue + 1) {
                  newState[y][x] = {
                    type: "red",
                    energy: Math.floor(Math.random() * 6) + 5,
                    age: 0,
                  };
                } else if (
                  counts.green >= 3 &&
                  counts.green > counts.red + 1 &&
                  counts.blue >= 1
                ) {
                  newState[y][x] = {
                    type: "green",
                    energy: Math.floor(Math.random() * 6) + 5,
                    age: 0,
                  };
                } else if (counts.blue >= 3 && counts.blue >= counts.red) {
                  newState[y][x] = {
                    type: "blue",
                    energy: Math.floor(Math.random() * 6) + 5,
                    age: 0,
                  };
                }
              }
            }
          }
        }

        // Satunnainen el√§m√§n kipin√§ - vain punaiset solut (0.1%)
        if (Math.random() < 0.1) {
          const rx = Math.floor(Math.random() * COLS);
          const ry = Math.floor(Math.random() * ROWS);
          if (!newState[ry][rx]) {
            // Vain tyhjille soluille
            newState[ry][rx] = {
              type: "red",
              energy:
                Math.floor(Math.random() * INITIAL_ENERGY_RANGE) +
                INITIAL_ENERGY_MIN,
              age: 0,
            };
          }
        }

        // Mutantti mekanismi (0.3% mahdollisuus)
        if (Math.random() < 0.003) {
          const rx = Math.floor(Math.random() * COLS);
          const ry = Math.floor(Math.random() * ROWS);
          const cell = newState[ry][rx];
          if (cell && cell.age > 10) {
            // Vain vanhemmat solut voivat mutantoida
            const types = SPECIES.filter((t) => t !== cell.type);
            const newType = types[Math.floor(Math.random() * types.length)];
            newState[ry][rx] = {
              type: newType,
              energy: Math.max(3, cell.energy - 2), // Energia sakko mutantoinnista
              age: 0, // Ik√§ nollautuu mutantoinnin j√§lkeen
            };
          }
        }

        state = newState;
        generation++; // Lis√§√§ sukupolvi
        // K√ÑYT√Ñ OPTIMOITUA RENDER√ñINTI√Ñ T√ÑSS√Ñ!
        updateGridDisplay();

        const counts = getCounts();

        // P√§√§ttymisehdot (Dominanssi)
        const total = counts.red + counts.green + counts.blue;
        if (total === 0) {
          stopSimulation();
          updateStats("üíÄ All life extinct.");
          return;
        }
        const threshold = ROWS * COLS * 0.25; // Esim. 25% ruudukosta (400 cells)

        if (
          (counts.green > threshold && counts.red < 10 && counts.blue < 10) ||
          (counts.red > threshold && counts.green < 10 && counts.blue < 10) ||
          (counts.blue > threshold && counts.green < 10 && counts.red < 10)
        ) {
          stopSimulation();
          updateStats("‚ò†Ô∏è One species dominates.");
          return;
        }

        updateStats();
      }

      // --- 6. TAPAHTUMANK√ÑSITTELIJ√ÑT JA K√ÑYTT√ñLIITTYM√Ñ ---
      function startSimulation() {
        if (!interval) {
          interval = setInterval(nextState, intervalTime);
          startBtn.textContent = "Stop";
        }
      }

      function stopSimulation() {
        if (interval) {
          clearInterval(interval);
          interval = null;
          startBtn.textContent = "Start";
        }
      }

      function resetSimulation() {
        stopSimulation();
        generation = 0; // Nollaa sukupolvien laskuri
        initializeState();
        updateGridDisplay();
        updateStats();
      }

      function savePattern() {
        const patternData = {
          state: state,
          generation: generation,
          timestamp: new Date().toISOString(),
        };
        localStorage.setItem(
          "lifeSimulationPattern",
          JSON.stringify(patternData)
        );
        updateStats("Pattern saved!");
        setTimeout(() => updateStats(), 2000);
      }

      function loadPattern() {
        const savedData = localStorage.getItem("lifeSimulationPattern");
        if (savedData) {
          try {
            const patternData = JSON.parse(savedData);
            state = patternData.state;
            generation = patternData.generation || 0;
            updateGridDisplay();
            updateStats("Pattern loaded!");
            setTimeout(() => updateStats(), 2000);
          } catch (e) {
            updateStats("Error loading pattern");
            setTimeout(() => updateStats(), 2000);
          }
        } else {
          updateStats("No saved pattern found");
          setTimeout(() => updateStats(), 2000);
        }
      }

      // K√§yt√§ funktioita
      startBtn.addEventListener("click", () => {
        if (interval) stopSimulation();
        else startSimulation();
      });

      speedBtn.addEventListener("click", () => {
        if (intervalTime === 600) {
          intervalTime = 300; // Faster but still reasonable
          speedBtn.textContent = "1x Speed";
        } else {
          intervalTime = 600;
          speedBtn.textContent = "2x Speed";
        }
        if (interval) {
          clearInterval(interval);
          interval = setInterval(nextState, intervalTime);
        }
      });

      resetBtn.addEventListener("click", resetSimulation);
      saveBtn.addEventListener("click", savePattern);
      loadBtn.addEventListener("click", loadPattern);
      conwayBtn.addEventListener("click", toggleConwayMode);
      themeSelector.addEventListener("change", (e) =>
        applyTheme(e.target.value)
      );

      fullscreenBtn.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          fullscreenBtn.textContent = "Exit Fullscreen";
        } else {
          document.exitFullscreen();
          fullscreenBtn.textContent = "Fullscreen";
        }
      });

      // N√§pp√§inkontrollit
      document.addEventListener("keydown", (event) => {
        switch (event.code) {
          case "Space":
            event.preventDefault();
            if (interval) stopSimulation();
            else startSimulation();
            break;
          case "KeyR":
            resetSimulation();
            break;
          case "KeyS":
            speedBtn.click();
            break;
        }
      });

      // Alustus
      initializeState();
      createInitialGrid(); // T√ÑRKE√Ñ: Luo DOM-elementit vain kerran
      applyTheme("fire-ice"); // Alusta oletusteema
      updateStats();

      // Lis√§√§ klikkausk√§sittelij√§t manuaaliseen solujen muokkaukseen
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          cellDivs[y][x].addEventListener("click", () => {
            if (interval) return; // √Ñl√§ salli muokkausta k√§ynniss√§ ollessa
            if (state[y][x]) {
              state[y][x] = null; // Poista solu
            } else {
              // Lis√§√§ satunnainen solu
              const types = SPECIES;
              state[y][x] = {
                type: types[Math.floor(Math.random() * types.length)],
                energy:
                  Math.floor(Math.random() * INITIAL_ENERGY_RANGE) +
                  INITIAL_ENERGY_MIN,
                age: 0,
              };
            }
            updateGridDisplay();
            updateStats();
          });
        }
      }
    </script>
  </body>
</html>
